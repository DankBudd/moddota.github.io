"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[7916],{3905:(e,t,n)=>{n.d(t,{Zo:()=>m,kt:()=>d});var o=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},r=Object.keys(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=o.createContext({}),c=function(e){var t=o.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},m=function(e){var t=c(e.components);return o.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},u=o.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,s=e.parentName,m=l(e,["components","mdxType","originalType","parentName"]),u=c(n),d=a,h=u["".concat(s,".").concat(d)]||u[d]||p[d]||r;return n?o.createElement(h,i(i({ref:t},m),{},{components:n})):o.createElement(h,i({ref:t},m))}));function d(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,i=new Array(r);i[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:a,i[1]=l;for(var c=2;c<r;c++)i[c]=n[c];return o.createElement.apply(null,i)}return o.createElement.apply(null,n)}u.displayName="MDXCreateElement"},3919:(e,t,n)=>{function o(e){return!0===/^(\w*:|\/\/)/.test(e)}function a(e){return void 0!==e&&!o(e)}n.d(t,{b:()=>o,Z:()=>a})},4996:(e,t,n)=>{n.d(t,{C:()=>r,Z:()=>i});var o=n(2263),a=n(3919);function r(){const{siteConfig:{baseUrl:e="/",url:t}={}}=(0,o.Z)();return{withBaseUrl:(n,o)=>function(e,t,n,{forcePrependBaseUrl:o=!1,absolute:r=!1}={}){if(!n)return n;if(n.startsWith("#"))return n;if((0,a.b)(n))return n;if(o)return t+n;const i=n.startsWith(t)?n:t+n.replace(/^\//,"");return r?e+i:i}(t,e,n,o)}}function i(e,t={}){const{withBaseUrl:n}=r();return n(e,t)}},8215:(e,t,n)=>{n.d(t,{Z:()=>a});var o=n(7294);const a=function({children:e,hidden:t,className:n}){return o.createElement("div",{role:"tabpanel",hidden:t,className:n},e)}},1395:(e,t,n)=>{n.d(t,{Z:()=>m});var o=n(7294),a=n(944),r=n(6010);const i="tabItem_1uMI",l="tabItemActive_2DSg";const s=37,c=39;const m=function(e){const{lazy:t,block:n,defaultValue:m,values:p,groupId:u,className:d}=e,{tabGroupChoices:h,setTabGroupChoices:f}=(0,a.Z)(),[b,g]=(0,o.useState)(m),y=o.Children.toArray(e.children),v=[];if(null!=u){const e=h[u];null!=e&&e!==b&&p.some((t=>t.value===e))&&g(e)}const k=e=>{const t=e.currentTarget,n=v.indexOf(t),o=p[n].value;g(o),null!=u&&(f(u,o),setTimeout((()=>{(function(e){const{top:t,left:n,bottom:o,right:a}=e.getBoundingClientRect(),{innerHeight:r,innerWidth:i}=window;return t>=0&&a<=i&&o<=r&&n>=0})(t)||(t.scrollIntoView({block:"center",behavior:"smooth"}),t.classList.add(l),setTimeout((()=>t.classList.remove(l)),2e3))}),150))},w=e=>{var t;let n;switch(e.keyCode){case c:{const t=v.indexOf(e.target)+1;n=v[t]||v[0];break}case s:{const t=v.indexOf(e.target)-1;n=v[t]||v[v.length-1];break}}null==(t=n)||t.focus()};return o.createElement("div",{className:"tabs-container"},o.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,r.Z)("tabs",{"tabs--block":n},d)},p.map((({value:e,label:t})=>o.createElement("li",{role:"tab",tabIndex:b===e?0:-1,"aria-selected":b===e,className:(0,r.Z)("tabs__item",i,{"tabs__item--active":b===e}),key:e,ref:e=>v.push(e),onKeyDown:w,onFocus:k,onClick:k},t)))),t?(0,o.cloneElement)(y.filter((e=>e.props.value===b))[0],{className:"margin-vert--md"}):o.createElement("div",{className:"margin-vert--md"},y.map(((e,t)=>(0,o.cloneElement)(e,{key:t,hidden:e.props.value!==b})))))}},9443:(e,t,n)=>{n.d(t,{Z:()=>o});const o=(0,n(7294).createContext)(void 0)},944:(e,t,n)=>{n.d(t,{Z:()=>r});var o=n(7294),a=n(9443);const r=function(){const e=(0,o.useContext)(a.Z);if(null==e)throw new Error("`useUserPreferencesContext` is used outside of `Layout` Component.");return e}},7840:(e,t,n)=>{n.d(t,{s:()=>a});var o=n(7294);function a({id:e,aspectRatio:t=4/3,hd:n="0"}){return o.createElement("p",{style:{position:"relative",paddingBottom:1/t*100+"%"}},o.createElement("iframe",{src:`https://gfycat.com/ifr/${e}?hd=${n}`,scrolling:"no",frameBorder:"0",allowFullScreen:!0,width:"100%",height:"100%",style:{position:"absolute",top:0,left:0}}))}},8173:(e,t,n)=>{n.d(t,{s:()=>s});var o=n(2177),a=n(8215),r=n(1395),i=n(7294);const l={lua:"Lua",ts:"TypeScript",tsx:"TypeScript",js:"JavaScript",jsx:"JavaScript"};function s({children:e,group:t,titles:n}){(0,o.Z)("string"==typeof t||void 0===t);const s=i.Children.toArray(e).map(((e,t)=>{var o;const a=(null==(o=e.props.children.props.className)?void 0:o.replace(/language-/,""))??`Tab ${t+1}`;return{id:t,languageName:(void 0!==n&&n.length>0?n.split("|"):[])[t]??l[a]??a,element:e}}));return i.createElement(r.Z,{groupId:void 0!==t?`multi-code-block-${t}`:void 0,defaultValue:s[0].id,values:s.map((({id:e,languageName:t})=>({value:e,label:t})))},s.map((({id:e,element:t})=>i.createElement(a.Z,{key:e,value:e},t))))}},6776:(e,t,n)=>{n.d(t,{X:()=>r});var o=n(4996),a=n(7294);function r({path:e,controls:t=!1}){return a.createElement("video",{width:"100%",height:"100%",autoPlay:!0,muted:!0,loop:!0,controls:t},a.createElement("source",{src:(0,o.Z)(e),type:"video/mp4"}))}},8129:(e,t,n)=>{n.d(t,{_:()=>a});var o=n(7294);function a({id:e,playlistId:t,aspectRatio:n=16/9}){const a=void 0!==t?`https://www.youtube.com/embed/videoseries?list=${t}`:`https://www.youtube.com/embed/${e}`;return o.createElement("p",{style:{position:"relative",paddingBottom:1/n*100+"%"}},o.createElement("iframe",{src:a,frameBorder:"0",allowFullScreen:!0,width:"100%",height:"100%",style:{position:"absolute",top:0,left:0}}))}},9937:(e,t,n)=>{n.r(t),n.d(t,{frontMatter:()=>i,metadata:()=>l,toc:()=>s,default:()=>m});var o=n(7462),a=(n(7294),n(3905)),r=(n(1395),n(8215),n(7840));n(8129),n(8173),n(6776);const i={title:"Item Drop System",author:"Noya",steamId:"76561198046984233",date:"17.05.2015"},l={unversionedId:"scripting/item-drop-system",id:"scripting/item-drop-system",isDocsHomePage:!1,title:"Item Drop System",description:"Here I'll go over the implementation of a flexible item drop system for any sort of gamemode, mostly useful for RPGs.",source:"@site/_articles/scripting/item-drop-system.md",sourceDirName:"scripting",slug:"/scripting/item-drop-system",permalink:"/scripting/item-drop-system",editUrl:"https://github.com/ModDota/moddota.github.io/edit/source/_articles/scripting/item-drop-system.md",version:"current",frontMatter:{title:"Item Drop System",author:"Noya",steamId:"76561198046984233",date:"17.05.2015"},sidebar:"tutorials",previous:{title:"Item Restrictions & Requirements",permalink:"/scripting/item-restrictions-requirements"},next:{title:'Making a "rpg-like" looting chest',permalink:"/scripting/making-a-rpg-like-looting-chest"}},s=[{value:"1. Key Values Table",id:"1-key-values-table",children:[]},{value:"2. OnEntityKilled Lua Event",id:"2-onentitykilled-lua-event",children:[]},{value:"3. RollDrops Lua Script",id:"3-rolldrops-lua-script",children:[]},{value:"4. Extending the solution to allow multiple drops of the same item",id:"4-extending-the-solution-to-allow-multiple-drops-of-the-same-item",children:[]},{value:"5. Extending to &quot;100% drop one of these&quot;",id:"5-extending-to-100-drop-one-of-these",children:[]}],c={toc:s};function m({components:e,...t}){return(0,a.kt)("wrapper",(0,o.Z)({},c,t,{components:e,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"Here I'll go over the implementation of a flexible item drop system for any sort of gamemode, mostly useful for RPGs."),(0,a.kt)("p",null,"There are multiple ways to do this, for example ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/MNoya/Warchasers/blob/master/scripts/npc/npc_abilities_custom.txt#L3687-L5667"},"Warchasers uses a pure datadriven system")," that goes over 2 thousand lines of abilities, each one for a different drop type... yeah you don't want to do that \ud83d\ude05 "),(0,a.kt)("p",null,"The best way for this is to have a text file to configure what items can drop from each unit, how many, its chances, etc, then whenever a unit dies, if it has an entry for item drops, handle the chances and drops accordingly, with a couple of choices that can be further extended if necessary."),(0,a.kt)(r.s,{id:"PowerlessCourageousAsiantrumpetfish",mdxType:"Gfycat"}),(0,a.kt)("hr",null),(0,a.kt)("h3",{id:"1-key-values-table"},"1. Key Values Table"),(0,a.kt)("p",null,"I recommend having a ",(0,a.kt)("em",{parentName:"p"},"kv")," folder under scripts to store this and other similar table files. The file can have any extension, but using ",(0,a.kt)("em",{parentName:"p"},".kv")," is a good convention."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'"Drops" \n{ \n    "creature_name1"\n    { \n        "item_name1" "10"\n        "item_name2" "50"\n        "item_name3" "100"\n    }\n}\n')),(0,a.kt)("p",null,"This table will set a creature to drop the first item with 10% chance, 50% on the second, and the third item will be dropped every time."),(0,a.kt)("p",null,"After saving and naming the file, this table has to be loaded in Lua, ideally in the initialization of the game mode, using the ",(0,a.kt)("inlineCode",{parentName:"p"},'LoadKeyValues("relative/path/to/file")')," this way:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-lua"},'GameRules.DropTable = LoadKeyValues("scripts/kv/item_drops.kv")\n')),(0,a.kt)("p",null,"In this initial version, each item drop chance is independent from the others. From the same creature there might be 1 drop, all of them, or none (if the chances are all less than 100). This behavior will be expanded later to provide some of the classic drop options."),(0,a.kt)("h3",{id:"2-onentitykilled-lua-event"},"2. OnEntityKilled Lua Event"),(0,a.kt)("p",null,"Simply listen to ",(0,a.kt)("inlineCode",{parentName:"p"},"entity_killed")," and call a custom RollDrops function with the killed unit as a parameter."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-lua"},"ListenToGameEvent('entity_killed', Dynamic_Wrap(GameMode, 'OnEntityKilled'), self)\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-lua"},"function GameMode:OnEntityKilled( keys )\n    local killedUnit = EntIndexToHScript( keys.entindex_killed )\n    if killedUnit:IsCreature() then\n        RollDrops(killedUnit)\n    end\nend\n")),(0,a.kt)("h3",{id:"3-rolldrops-lua-script"},"3. RollDrops Lua Script"),(0,a.kt)("p",null,"Now given the subtable of the unit name contained in the main Drop Table, if it exists, iterate over the elements rolling each chance value."),(0,a.kt)("p",null,"If the Roll succeeds, proceed to create an item handle with the name, and ",(0,a.kt)("inlineCode",{parentName:"p"},"LaunchLoot")," it with some fancy parameters (could also just use a ",(0,a.kt)("inlineCode",{parentName:"p"},"CreateItemOnPositionSync")," to drop the item instantly at the death position)"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-lua"},"function RollDrops(unit)\n    local DropInfo = GameRules.DropTable[unit:GetUnitName()]\n    if DropInfo then\n        for item_name,chance in pairs(DropInfo) do\n            if RollPercentage(chance) then\n                -- Create the item\n                local item = CreateItem(item_name, nil, nil)\n                local pos = unit:GetAbsOrigin()\n                local drop = CreateItemOnPositionSync( pos, item )\n                local pos_launch = pos+RandomVector(RandomFloat(150,200))\n                item:LaunchLoot(false, 200, 0.75, pos_launch)\n            end\n        end\n    end\nend\n")),(0,a.kt)("h3",{id:"4-extending-the-solution-to-allow-multiple-drops-of-the-same-item"},"4. Extending the solution to allow multiple drops of the same item"),(0,a.kt)("p",null,'The way Lua KV tables work, it\'s not possible to have more than 1 of the same index, so if we were to add 2 "item_name1" entries both with some chance value, LoadKeyValues would fail.'),(0,a.kt)("p",null,"To get around this, the table has to use another level and have each possible item drop of the unit be a table by itself:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'"Drops" \n{ \n    "creature_name1"\n    { \n        "1"\n        {\n            "Item"     "item_name1"\n            "Chance"   "10"\n            "Multiple" "3"\n        }\n        "2"\n        {\n            "Item"     "item_name2"\n            "Chance"   "50"\n            "Multiple" "1"\n        }\n    }\n}\n')),(0,a.kt)("p",null,"This structure along with the Multiple value will allow an item to be dropped more than once from the same creature. ",(0,a.kt)("em",{parentName:"p"},'"Multiple" "1"')," will just be 1 drop max."),(0,a.kt)("p",null,"The RollDrops function needs to be adjusted to read the subtables and the Item/Chance in a slightly different way:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-lua"},'function RollDrops(unit)\n    local DropInfo = GameRules.DropTable[unit:GetUnitName()]\n    if DropInfo then\n        for k,ItemTable in pairs(DropInfo) do\n            local chance = ItemTable.Chance or 100\n            local max_drops = ItemTable.Multiple or 1\n            local item_name = ItemTable.Item\n            for i=1,max_drops do\n                if RollPercentage(chance) then\n                    print("Creating "..item_name)\n                    local item = CreateItem(item_name, nil, nil)\n                    item:SetPurchaseTime(0)\n                    local pos = unit:GetAbsOrigin()\n                    local drop = CreateItemOnPositionSync( pos, item )\n                    local pos_launch = pos+RandomVector(RandomFloat(150,200))\n                    item:LaunchLoot(false, 200, 0.75, pos_launch)\n                end\n            end\n        end\n    end\nend\n')),(0,a.kt)("p",null,"The 'or 100' and 'or 1' are just to make sure that if the \"Chance\" or \"Multiple\" lines are missing, a default value ('drop always' and 'drop 1') will be used."),(0,a.kt)("h3",{id:"5-extending-to-100-drop-one-of-these"},'5. Extending to "100% drop one of these"'),(0,a.kt)("p",null,'Sometimes doing "50% of item 1 and 50% of item 2" is too random, because it will mean sometimes a mob will drop nothing, and sometimes it might drop 2. In order to reduce the randomness and ensure a certain combination of items will drop, the most common approach is to have a set list of possible drops, and make it so that the unit will drop only one of that set at random.'),(0,a.kt)("p",null,"To do this, instead of tying a single item to each item table, there will be yet another table of the { possible Set of items } that we want this creature to drop:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'"Drops" \n{ \n    "creature_name1"\n    { \n        "1"\n        {\n            "ItemSets"\n            {\n                "1" "item_name_set1"\n                "2" "item_name_set2"\n                "3" "item_name_set3"\n            }\n            "Chance"   "100" //of dropping 1 of the set\n        }\n        "2"\n        {\n            "Item"     "item_name2"\n            "Chance"   "50"\n            "Multiple" "3"\n        }\n    }\n}\n')),(0,a.kt)("p",null,'The ItemSets entry could also have a "Multiple" kv if we wanted an scenario like "2 of these 3", but this can\'t guarantee that the 2nd roll won\'t drop the same item than the first, if it did.'),(0,a.kt)("p",null,"And the RollDrops now looks like this:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-lua"},'function RollDrops(unit)\n    local DropInfo = GameRules.DropTable[unit:GetUnitName()]\n    if DropInfo then\n        print("Rolling Drops for "..unit:GetUnitName())\n        for k,ItemTable in pairs(DropInfo) do\n            -- If its an ItemSet entry, decide which item to drop\n            local item_name\n            if ItemTable.ItemSets then\n                -- Count how many there are to choose from\n                local count = 0\n                for i,v in pairs(ItemTable.ItemSets) do\n                    count = count+1\n                end\n                local random_i = RandomInt(1,count)\n                item_name = ItemTable.ItemSets[tostring(random_i)]\n            else\n                item_name = ItemTable.Item\n            end\n            local chance = ItemTable.Chance or 100\n            local max_drops = ItemTable.Multiple or 1\n            for i=1,max_drops do\n                print("Rolling chance "..chance)\n                if RollPercentage(chance) then\n                    print("Creating "..item_name)\n                    local item = CreateItem(item_name, nil, nil)\n                    item:SetPurchaseTime(0)\n                    local pos = unit:GetAbsOrigin()\n                    local drop = CreateItemOnPositionSync( pos, item )\n                    local pos_launch = pos+RandomVector(RandomFloat(150,200))\n                    item:LaunchLoot(false, 200, 0.75, pos_launch)\n                end\n            end\n        end\n    end\nend\n')),(0,a.kt)("hr",null),(0,a.kt)("h4",{id:"example"},"Example"),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://github.com/Aleteh/TBR3/blob/master/game/dota_addons/theblackroad3/scripts/kv/item_drops.kv"},"item_drops.kv file at TBR")),(0,a.kt)("p",null,"Leave any questions or suggestions below"))}m.isMDXComponent=!0},6010:(e,t,n)=>{function o(e){var t,n,a="";if("string"==typeof e||"number"==typeof e)a+=e;else if("object"==typeof e)if(Array.isArray(e))for(t=0;t<e.length;t++)e[t]&&(n=o(e[t]))&&(a&&(a+=" "),a+=n);else for(t in e)e[t]&&(a&&(a+=" "),a+=t);return a}function a(){for(var e,t,n=0,a="";n<arguments.length;)(e=arguments[n++])&&(t=o(e))&&(a&&(a+=" "),a+=t);return a}n.d(t,{Z:()=>a})}}]);