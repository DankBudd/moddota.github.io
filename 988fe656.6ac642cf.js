(window.webpackJsonp=window.webpackJsonp||[]).push([[45],{145:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return a})),n.d(t,"metadata",(function(){return o})),n.d(t,"rightToc",(function(){return s})),n.d(t,"default",(function(){return l}));var r=n(2),i=(n(0),n(196));n(188),n(189),n(197),n(198),n(199),n(200);const a={title:"Advanced rpg looting chest in typescript",author:"schloerk",steamId:76561198385531120,date:"10.07.2021"},o={id:"scripting/advanced-looting-chest",isDocsHomePage:!1,title:"Advanced rpg looting chest in typescript",description:"In this guide you will learn to create a channeling chest, which drops loot.",source:"@site/_articles/scripting/advanced-looting-chest.md",permalink:"/scripting/advanced-looting-chest",editUrl:"https://github.com/ModDota/moddota.github.io/edit/source/_articles/scripting/advanced-looting-chest.md"},s=[],c={rightToc:s};function l({components:e,...t}){return Object(i.b)("wrapper",Object(r.a)({},c,t,{components:e,mdxType:"MDXLayout"}),Object(i.b)("p",null,'In this guide you will learn to create a channeling chest, which drops loot.\nThe tricky part is to scale that item, because "Scale" is not supported, and to keep that item while channeling. Also you want to replace it with a opened chest model after successfully opening it. If the channeling fails, you also want to keep the chest.\nIt also should keep the scale and rotation. Also the chest we are using has two different material sets and of course we want to support "Skin" either.'),Object(i.b)("p",null,"So we gotta implement that. Lets go."),Object(i.b)("p",null,"In our example we use models/props_generic/chest_treasure_02.vmdl and models\\props_generic\\chest_treasure_02_open.vmdl, which both have a golden and brown material. 0 is brown, 1 is gold."),Object(i.b)("pre",null,Object(i.b)("code",Object(r.a)({parentName:"pre"},{}),'"DOTAAbilities"\n{\n\n    "item_treasure_chest_2"\n    {\n    "BaseClass"                       "item_lua"\n    "Model"                           "models/props_generic/chest_treasure_02.vmdl"\n        "ScriptFile"                      "item_treasure_chest_2.lua"\n        "AbilityBehavior"                 "DOTA_ABILITY_BEHAVIOR_CHANNELLED"\n    "AbilityTextureName"              "item_desolator"\n\n        "ItemShareability"                 "ITEM_FULLY_SHAREABLE"\n        "ItemKillable"                     "0"\n        "ItemSellable"                     "0" \n        "ItemPurchasable"                  "0"\n        "ItemDroppable"                    "1" \n        "ItemPermanent"                    "0"\n        "ItemCost"                         "99999" \n        \n        "AbilityCooldown"                  "0.0" // Ability cooldown must be 0\n        "AbilityChannelTime"               "2.5"\n        "AbilityUnitTargetType"           "DOTA_UNIT_TARGET_HERO"\n        "OnlyPlayerHeroPickup"            "1"\n        "CreepHeroPickup"                 "1"\n        "DisplayOverheadAlertOnReceived"  "0" // Show no item accquired overhead effect\n        "ItemCastOnPickup"                "1" // Start channeling on pickup\n\n        // Custom Values\n        // -------------\n        "ReplaceOnOpen"                   "models\\props_generic\\chest_treasure_02_open.vmdl"\n        "Skin"                            "1"\n    }\n}\n')),Object(i.b)("p",null,"Instead of item_desolator, you should use a better icon :)"),Object(i.b)("pre",null,Object(i.b)("code",Object(r.a)({parentName:"pre"},{className:"language-ts"}),'// registerAbility() and BaseItem is provided by dota_ts_adapter and needs to imported.\n\n@registerAbility()\nclass item_treasure_chest_2 extends BaseItem {\n\n    position!: Vector;\n    angles!: Vector;\n    kv!: Record<string, string>;\n    channelingPlaceholder!: CBaseAnimating;\n\n    Spawn() {\n        if (IsServer()) {\n            this.kv = this.GetAbilityKeyValues() as Record<string, string>;           \n            this.HandleSkinAndScale();\n        }\n    }\n\n    private HandleSkinAndScale(){\n        const kvSkin = this.GetSkin();\n        const kvScale = this.GetScale();\n\n        if(kvSkin == 0 && kvScale == 1){\n            return;\n        }\n        // Container is not created by engine at Spawn() time\n        Timers.CreateTimer(0.01, () => {\n            const container = this.GetContainer();\n\n            if(container){\n                container.SetSkin(kvSkin);\n                container.SetModelScale(kvScale);\n            }\n        });\n    }\n\n    // Since we channel this ability on pickup it isnt the same as the item icon, so we need to set it here.\n    // When using a custom icon, make sure to support both formats (spellicon/icon)\n    GetAbilityTextureName() {\n        return GetAbilityTextureNameForAbility(this.GetName());\n    }\n\n    // OnSpellStart gets called twice for some reason, thats why we check if position and placeholder are set\n    OnSpellStart() {\n        if (IsClient()) {\n            return;\n        }\n\n        if(!this.position){\n            this.position = this.GetContainer()!.GetOrigin();\n            this.angles = this.GetContainer()!.GetAnglesAsVector();\n        }\n\n        if (!this.channelingPlaceholder) {\n           this.channelingPlaceholder = this.SpawnReplacementChests(this.GetChestModel());\n        }\n    }\n\n    OnChannelFinish(interrupted: boolean) {\n        if (IsClient()) {\n            return;\n        }\n        if (interrupted) {\n            this.RedropChest();\n            this.DeleteChest();\n            return;\n        }\n        this.OnChestOpen();\n    }\n\n    OnChestOpen() {\n        print("Opened chest");\n        \n        this.CreateLoot();\n        this.SpawnReplacementChests(this.GetChestOpenModel());\n        this.DeleteChest();\n    }\n\n    // spawned chests do not have a collider\n    private SpawnReplacementChests(model: string): CBaseAnimating{\n\n        const item = SpawnEntityFromTableSynchronous("prop_dynamic", {\n            model: model,\n            scale: this.GetScale(),\n            origin: this.position,\n            angles: this.angles,\n            skin: this.GetSkin()\n        }) as CBaseAnimating;\n\n        item.ResetSequence("chest_treasure_idle");\n\n        return item as CBaseAnimating;\n    }\n\n    private RedropChest() {\n        const chestReplace = CreateItem(this.GetName(), undefined, undefined);\n        const item = CreateItemOnPositionSync(this.position, chestReplace);\n        item.SetAngles(this.angles.x, this.angles.y, this.angles.z);\n        item.SetModelScale(this.GetScale());\n        item.ResetSequence("chest_treasure_idle");\n    }\n\n    private DeletePlaceholder(){\n        this.channelingPlaceholder.RemoveSelf();\n    }\n\n    private DeleteChest() {\n        // Removing an item also destroys the underlying entity, be carefull\n        this.GetCaster().RemoveItem(this);\n        this.DeletePlaceholder();\n    }\n\n    private CreateLoot(){\n        const caster = this.GetCaster();\n\n        const item = CreateItem("item_desolator", caster.GetPlayerOwner(), undefined);\n        const worldItem = CreateItemOnPositionSync(this.position, item);\n        item?.LaunchLoot(false, 124, RandomFloat(0.5, 1.2), caster.GetOrigin().__add(RandomVector(RandomInt(50, 150))));\n    }\n\n    private GetChestOpenModel() {\n        return this.kv["ReplaceOnOpen"];\n    }\n\n    private GetChestModel(){\n        return this.kv["Model"];\n    }\n\n    private GetSkin(){\n        return tonumber(this.kv["Skin"]) || 0;\n    }\n\n    protected GetScale(){\n        return tonumber(this.kv["Scale"]) || 1;\n    }\n}\n')),Object(i.b)("p",null,'Finally you will want to give your chest a tooltip name. Add "DOTA',Object(i.b)("em",{parentName:"p"},'Tooltip_ability_item_treasure_chest_2"\t\t\t"Testchest" to your addon'),"*.txt."),Object(i.b)("p",null,"There are some drawbacks to this approach. You cant change the pickup range and the itemquality. Please leave a comment in discord or edit this page, if you know."))}l.isMDXComponent=!0},188:function(e,t,n){"use strict";var r=n(0),i=n.n(r),a=n(195),o=n(192),s=n(90),c=n.n(s);const l=37,u=39;t.a=function(e){const{block:t,children:n,defaultValue:s,values:p,groupId:d}=e,{tabGroupChoices:h,setTabGroupChoices:m}=Object(a.a)(),[f,b]=Object(r.useState)(s);if(null!=d){const e=h[d];null!=e&&e!==f&&p.some(t=>t.value===e)&&b(e)}const g=e=>{b(e),null!=d&&m(d,e)},v=[];return i.a.createElement("div",null,i.a.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:Object(o.a)("tabs",{"tabs--block":t})},p.map(({value:e,label:t})=>i.a.createElement("li",{role:"tab",tabIndex:"0","aria-selected":f===e,className:Object(o.a)("tabs__item",c.a.tabItem,{"tabs__item--active":f===e}),key:e,ref:e=>v.push(e),onKeyDown:e=>((e,t,n)=>{switch(n.keyCode){case u:((e,t)=>{const n=e.indexOf(t)+1;e[n]?e[n].focus():e[0].focus()})(e,t);break;case l:((e,t)=>{const n=e.indexOf(t)-1;e[n]?e[n].focus():e[e.length-1].focus()})(e,t)}})(v,e.target,e),onFocus:()=>g(e),onClick:()=>g(e)},t))),i.a.createElement("div",{role:"tabpanel",className:"margin-vert--md"},r.Children.toArray(n).filter(e=>e.props.value===f)[0]))}},189:function(e,t,n){"use strict";var r=n(0),i=n.n(r);t.a=function(e){return i.a.createElement("div",null,e.children)}},190:function(e,t,n){"use strict";var r=n(0),i=n(34);t.a=function(){return Object(r.useContext)(i.a)}},191:function(e,t,n){"use strict";function r(e){return!1===/^(https?:|\/\/|mailto:|tel:)/.test(e)}n.d(t,"a",(function(){return r}))},192:function(e,t,n){"use strict";function r(e){var t,n,i="";if("string"==typeof e||"number"==typeof e)i+=e;else if("object"==typeof e)if(Array.isArray(e))for(t=0;t<e.length;t++)e[t]&&(n=r(e[t]))&&(i&&(i+=" "),i+=n);else for(t in e)e[t]&&(i&&(i+=" "),i+=t);return i}t.a=function(){for(var e,t,n=0,i="";n<arguments.length;)(e=arguments[n++])&&(t=r(e))&&(i&&(i+=" "),i+=t);return i}},193:function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var r=n(190),i=n(191);function a(e,{forcePrependBaseUrl:t=!1,absolute:n=!1}={}){const{siteConfig:{baseUrl:a="/",url:o}={}}=Object(r.a)();if(!e)return e;if(t)return a+e;if(!Object(i.a)(e))return e;const s=a+e.replace(/^\//,"");return n?o+s:s}},194:function(e,t,n){"use strict";var r=n(0);const i=Object(r.createContext)({tabGroupChoices:{},setTabGroupChoices:()=>{},isAnnouncementBarClosed:!1,closeAnnouncementBar:()=>{}});t.a=i},195:function(e,t,n){"use strict";var r=n(0),i=n(194);t.a=function(){return Object(r.useContext)(i.a)}},196:function(e,t,n){"use strict";n.d(t,"a",(function(){return p})),n.d(t,"b",(function(){return m}));var r=n(0),i=n.n(r);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,r,i=function(e,t){if(null==e)return{};var n,r,i={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=i.a.createContext({}),u=function(e){var t=i.a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},p=function(e){var t=u(e.components);return i.a.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return i.a.createElement(i.a.Fragment,{},t)}},h=i.a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,a=e.originalType,o=e.parentName,l=c(e,["components","mdxType","originalType","parentName"]),p=u(n),h=r,m=p["".concat(o,".").concat(h)]||p[h]||d[h]||a;return n?i.a.createElement(m,s(s({ref:t},l),{},{components:n})):i.a.createElement(m,s({ref:t},l))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=n.length,o=new Array(a);o[0]=h;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var l=2;l<a;l++)o[l]=n[l];return i.a.createElement.apply(null,o)}return i.a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},197:function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var r=n(0),i=n.n(r);function a({id:e,aspectRatio:t=4/3,hd:n="0"}){return i.a.createElement("p",{style:{position:"relative",paddingBottom:1/t*100+"%"}},i.a.createElement("iframe",{src:`https://gfycat.com/ifr/${e}?hd=${n}`,scrolling:"no",frameBorder:"0",allowFullScreen:!0,width:"100%",height:"100%",style:{position:"absolute",top:0,left:0}}))}},198:function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var r=n(0),i=n.n(r);function a({id:e,playlistId:t,aspectRatio:n=16/9}){const r=void 0!==t?"https://www.youtube.com/embed/videoseries?list="+t:"https://www.youtube.com/embed/"+e;return i.a.createElement("p",{style:{position:"relative",paddingBottom:1/n*100+"%"}},i.a.createElement("iframe",{src:r,frameBorder:"0",allowFullScreen:!0,width:"100%",height:"100%",style:{position:"absolute",top:0,left:0}}))}},199:function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var r=n(3),i=n(189),a=n(188),o=n(0),s=n.n(o);const c={lua:"Lua",ts:"TypeScript",tsx:"TypeScript",js:"JavaScript",jsx:"JavaScript"};function l({children:e,group:t,titles:n}){Object(r.a)("string"==typeof t||void 0===t);const o=s.a.Children.toArray(e).map((e,t)=>{var r,i,a,o;const s=null!==(r=null===(i=e.props.children.props.className)||void 0===i?void 0:i.replace(/language-/,""))&&void 0!==r?r:"Tab "+(t+1);return{id:t,languageName:null!==(a=null!==(o=(void 0!==n&&n.length>0?n.split("|"):[])[t])&&void 0!==o?o:c[s])&&void 0!==a?a:s,element:e}});return s.a.createElement(a.a,{groupId:void 0!==t?"multi-code-block-"+t:void 0,defaultValue:o[0].id,values:o.map(({id:e,languageName:t})=>({value:e,label:t}))},o.map(({id:e,element:t})=>s.a.createElement(i.a,{key:e,value:e},t)))}},200:function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var r=n(193),i=n(0),a=n.n(i);function o({path:e,controls:t=!1}){return a.a.createElement("video",{width:"100%",height:"100%",autoPlay:!0,muted:!0,loop:!0,controls:t},a.a.createElement("source",{src:Object(r.a)(e),type:"video/mp4"}))}}}]);